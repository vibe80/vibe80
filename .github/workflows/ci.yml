name: CI

on:
  push:
  pull_request:

permissions:
  contents: write
  packages: write

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      base_image: ${{ steps.filter.outputs.base_image }}
      android: ${{ steps.filter.outputs.android }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            base_image:
              - 'tools/**'
              - 'docker/**'
              - 'docker/Dockerfile.base'
            android:
              - 'mobile/**'

  server_tests:
    runs-on: ubuntu-latest
    needs: changes
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - run: npm ci
      - run: npm --workspace server run test

  build_base_image_main:
    runs-on: ubuntu-latest
    needs: server_tests
    if: github.event_name == 'push' && github.ref_name == 'main'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.base
          push: true
          tags: ghcr.io/vibe80/vibe80-base:latest

  build_base_image_non_main:
    runs-on: ubuntu-latest
    needs: changes
    if: github.event_name == 'push' && github.ref_name != 'main' && needs.changes.outputs.base_image == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.base
          push: true
          tags: ghcr.io/vibe80/vibe80-base:latest

  build_android_apk:
    runs-on: ubuntu-latest
    needs: [changes, server_tests]
    if: github.event_name == 'push' && github.ref_name == 'main' && needs.changes.outputs.android == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - uses: android-actions/setup-android@v3
      - name: Build debug APK
        working-directory: mobile
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platforms;android-35" "build-tools;35.0.0" || true
          sh ./gradlew :androidApp:assembleDebug --no-daemon --stacktrace
      - name: Upload APK artifact (GitHub)
        uses: actions/upload-artifact@v4
        with:
          name: vibe80-android-debug-${{ github.sha }}
          path: mobile/androidApp/build/outputs/apk/debug/*.apk

  build_android_release_apk:
    runs-on: ubuntu-latest
    needs: server_tests
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - uses: android-actions/setup-android@v3
      - name: Decode Android keystore
        working-directory: mobile
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > release.keystore
          chmod 600 release.keystore
      - name: Build signed release APK
        working-directory: mobile
        env:
          ANDROID_KEYSTORE_PATH: ${{ github.workspace }}/mobile/release.keystore
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platforms;android-35" "build-tools;35.0.0" || true
          sh ./gradlew :androidApp:assembleRelease --no-daemon --stacktrace
      - name: Upload APK artifact (GitHub)
        uses: actions/upload-artifact@v4
        with:
          name: vibe80-android-release-${{ github.ref_name }}
          path: mobile/androidApp/build/outputs/apk/release/*.apk
      - name: Publish APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: mobile/androidApp/build/outputs/apk/release/*.apk
          generate_release_notes: true

  build_image:
    runs-on: ubuntu-latest
    needs: [build_base_image_main, build_base_image_non_main]
    if: always() && github.event_name == 'push' && needs.build_base_image_main.result != 'failure' && needs.build_base_image_main.result != 'cancelled' && needs.build_base_image_non_main.result != 'failure' && needs.build_base_image_non_main.result != 'cancelled'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Compute tags
        id: vars
        run: echo "short_sha=${GITHUB_SHA::8}" >> "$GITHUB_OUTPUT"
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          cache-from: type=registry,ref=ghcr.io/vibe80/vibe80:latest
          tags: |
            ghcr.io/vibe80/vibe80:${{ steps.vars.outputs.short_sha }}
            ghcr.io/vibe80/vibe80:latest

  mirror_image_dockerhub:
    runs-on: ubuntu-latest
    needs: build_image
    if: always() && github.event_name == 'push' && needs.build_image.result == 'success'
    steps:
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Compute tags
        id: vars
        run: echo "short_sha=${GITHUB_SHA::8}" >> "$GITHUB_OUTPUT"
      - name: Mirror short SHA tag to Docker Hub
        run: |
          docker buildx imagetools create \
            -t docker.io/vibe80/vibe80:${{ steps.vars.outputs.short_sha }} \
            ghcr.io/vibe80/vibe80:${{ steps.vars.outputs.short_sha }}
      - name: Mirror latest tag to Docker Hub
        run: |
          docker buildx imagetools create \
            -t docker.io/vibe80/vibe80:latest \
            ghcr.io/vibe80/vibe80:latest
