name: CI

on:
  push:
  pull_request:

permissions:
  contents: write
  packages: write

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      base_image: ${{ steps.filter.outputs.base_image }}
      android: ${{ steps.filter.outputs.android }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            base_image:
              - 'tools/**'
              - 'docker/**'
              - 'docker/Dockerfile.base'
            android:
              - 'mobile/**'

  ref_scope:
    runs-on: ubuntu-latest
    outputs:
      on_main: ${{ steps.scope.outputs.on_main }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: scope
        shell: bash
        run: |
          ON_MAIN=false
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            ON_MAIN=true
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            git fetch origin main --quiet
            if git merge-base --is-ancestor "${GITHUB_SHA}" "origin/main"; then
              ON_MAIN=true
            fi
          fi
          echo "on_main=${ON_MAIN}" >> "$GITHUB_OUTPUT"

  server_tests:
    runs-on: ubuntu-latest
    needs: [changes, ref_scope]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - run: npm ci
      - run: npm --workspace server run test

  build_base_image_main:
    runs-on: ubuntu-latest
    needs: [server_tests, ref_scope]
    if: github.event_name == 'push' && github.ref_name == 'main' && needs.ref_scope.outputs.on_main == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.base
          push: true
          tags: ghcr.io/vibe80/vibe80-base:latest

  build_base_image_non_main:
    runs-on: ubuntu-latest
    needs: changes
    if: false
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.base
          push: true
          tags: ghcr.io/vibe80/vibe80-base:latest

  build_android_apk:
    runs-on: ubuntu-latest
    needs: [changes, server_tests]
    if: github.event_name == 'push' && needs.changes.outputs.android == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - uses: android-actions/setup-android@v3
      - name: Build debug APK
        working-directory: mobile
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platforms;android-35" "build-tools;35.0.0" || true
          sh ./gradlew :androidApp:assembleDebug --no-daemon --stacktrace
      - name: Upload APK artifact (GitHub)
        uses: actions/upload-artifact@v4
        with:
          name: vibe80-android-debug-${{ github.sha }}
          path: mobile/androidApp/build/outputs/apk/debug/*.apk

  build_android_release_apk:
    runs-on: ubuntu-latest
    needs: [server_tests, ref_scope]
    if: startsWith(github.ref, 'refs/tags/v') && needs.ref_scope.outputs.on_main == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - uses: android-actions/setup-android@v3
      - name: Decode Android keystore
        working-directory: mobile
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > release.keystore
          chmod 600 release.keystore
      - name: Compute Android version from tag
        id: android_version
        run: |
          TAG="${GITHUB_REF_NAME#v}"
          if ! [[ "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid tag format for Android versioning: $GITHUB_REF_NAME (expected vMAJOR.MINOR.PATCH)"
            exit 1
          fi
          IFS='.' read -r MAJOR MINOR PATCH <<< "$TAG"
          VERSION_CODE=$((10#$MAJOR * 10000 + 10#$MINOR * 100 + 10#$PATCH))
          echo "version_name=$TAG" >> "$GITHUB_OUTPUT"
          echo "version_code=$VERSION_CODE" >> "$GITHUB_OUTPUT"
      - name: Build signed release APK
        working-directory: mobile
        env:
          ANDROID_KEYSTORE_PATH: ${{ github.workspace }}/mobile/release.keystore
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_VERSION_NAME: ${{ steps.android_version.outputs.version_name }}
          ANDROID_VERSION_CODE: ${{ steps.android_version.outputs.version_code }}
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platforms;android-35" "build-tools;35.0.0" || true
          sh ./gradlew :androidApp:assembleRelease --no-daemon --stacktrace
      - name: Upload APK artifact (GitHub)
        uses: actions/upload-artifact@v4
        with:
          name: vibe80-android-release-${{ github.ref_name }}
          path: mobile/androidApp/build/outputs/apk/release/*.apk
      - name: Publish APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: mobile/androidApp/build/outputs/apk/release/*.apk
          generate_release_notes: true

  publish_npm:
    runs-on: ubuntu-latest
    needs: [server_tests, ref_scope]
    if: startsWith(github.ref, 'refs/tags/v') && needs.ref_scope.outputs.on_main == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'
      - run: npm ci
      - name: Align package version with git tag
        run: |
          TAG="${GITHUB_REF_NAME#v}"
          if ! [[ "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid tag format: $GITHUB_REF_NAME (expected vMAJOR.MINOR.PATCH)"
            exit 1
          fi
          npm version "$TAG" --no-git-tag-version --allow-same-version
      - name: Publish package to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public

  build_image:
    runs-on: ubuntu-latest
    needs: [build_base_image_main, build_base_image_non_main, ref_scope]
    if: always() && github.event_name == 'push' && needs.ref_scope.outputs.on_main == 'true' && needs.build_base_image_main.result != 'failure' && needs.build_base_image_main.result != 'cancelled' && needs.build_base_image_non_main.result != 'failure' && needs.build_base_image_non_main.result != 'cancelled'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Compute tags
        id: vars
        run: |
          echo "short_sha=${GITHUB_SHA::8}" >> "$GITHUB_OUTPUT"
          TAGS="ghcr.io/vibe80/vibe80:${GITHUB_SHA::8}\nghcr.io/vibe80/vibe80:latest"
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            echo "version_tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
            TAGS="${TAGS}\nghcr.io/vibe80/vibe80:${GITHUB_REF_NAME}"
          else
            echo "version_tag=" >> "$GITHUB_OUTPUT"
          fi
          echo "ghcr_tags<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$TAGS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          cache-from: type=registry,ref=ghcr.io/vibe80/vibe80:latest
          tags: ${{ steps.vars.outputs.ghcr_tags }}

  mirror_image_dockerhub:
    runs-on: ubuntu-latest
    needs: [build_image, ref_scope]
    if: always() && github.event_name == 'push' && needs.ref_scope.outputs.on_main == 'true' && needs.build_image.result == 'success'
    steps:
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Compute tags
        id: vars
        run: |
          echo "short_sha=${GITHUB_SHA::8}" >> "$GITHUB_OUTPUT"
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            echo "version_tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          else
            echo "version_tag=" >> "$GITHUB_OUTPUT"
          fi
      - name: Mirror short SHA tag to Docker Hub
        run: |
          docker buildx imagetools create \
            -t docker.io/vibe80/vibe80:${{ steps.vars.outputs.short_sha }} \
            ghcr.io/vibe80/vibe80:${{ steps.vars.outputs.short_sha }}
      - name: Mirror latest tag to Docker Hub
        run: |
          docker buildx imagetools create \
            -t docker.io/vibe80/vibe80:latest \
            ghcr.io/vibe80/vibe80:latest
      - name: Mirror version tag to Docker Hub
        if: steps.vars.outputs.version_tag != ''
        run: |
          docker buildx imagetools create \
            -t docker.io/vibe80/vibe80:${{ steps.vars.outputs.version_tag }} \
            ghcr.io/vibe80/vibe80:${{ steps.vars.outputs.version_tag }}
