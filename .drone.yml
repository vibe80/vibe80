---
kind: pipeline
type: kubernetes
name: build

platform:
  os: linux
  arch: amd64

steps:
  - name: build_image
    image: plugins/docker:20.14
    settings:
      username:
        from_secret: registry_username
      password:
        from_secret: registry_token
      registry: git.lab.adho.app
      repo: git.lab.adho.app/mont5piques/m5chat
      dockerfile: Dockerfile
      context: .
      mtu: 1440
      cache_from:
        - git.lab.adho.app/mont5piques/m5chat:latest
      tags:
        - ${DRONE_COMMIT_SHA:0:8}
        - latest
  - name: update_gitops_vibecoder
    image: alpine:3.20
    when:
      branch:
        - main
    environment:
      GITOPS_SSH_KEY:
        from_secret: gitops_ssh_key
    commands:
      - apk add --no-cache git openssh yq
      - mkdir -p ~/.ssh
      - echo "$GITOPS_SSH_KEY" > ~/.ssh/id_rsa
      - chmod 600 ~/.ssh/id_rsa
      - ssh-keyscan -H gitea.devops >> ~/.ssh/known_hosts 2>/dev/null || true

      - git clone git@gitea.devops:mont5piques/gitops.git gitops
      - cd gitops

      - export TAG="${DRONE_COMMIT_SHA:0:8}"

      - yq -i '
          (select(.kind=="Deployment" and .metadata.name=="vibecoder")
            .spec.template.spec.containers[] | select(.name=="vibecoder").image)
          = "git.lab.adho.app/mont5piques/m5chat:" + strenv(TAG)
        ' contabo/vibecoder/vibecoder.yml

      - git config user.email "drone@company.local"
      - git config user.name "drone-ci"
      - git add contabo/vibecoder/vibecoder.yml
      - 'git commit -m "vibecoder: bump image to ${TAG}" || exit 0'
      - git push


trigger:
  event:
    - push
    - pull_request
