---
kind: pipeline
type: kubernetes
name: build

platform:
  os: linux
  arch: amd64

steps:
  - name: build_base_image
    image: plugins/docker:20.14
    when:
      branch:
        - main
      event:
        - push
      target:
        - production
      paths:
        - tools/**
        - docker/**
        - Dockerfile.base
    settings:
      username:
        from_secret: registry_username
      password:
        from_secret: registry_token
      registry: git.lab.adho.app
      repo: git.lab.adho.app/mont5piques/vibe80-base
      dockerfile: Dockerfile.base
      context: .
      mtu: 1440
      tags:
        - latest

  - name: build_android_apk
    image: thyrlian/android-sdk:latest
    when:
      branch:
        - android
      event:
        - push
      paths:
        - mobile/**
    environment:
      REGISTRY_USERNAME:
        from_secret: registry_username
      REGISTRY_TOKEN:
        from_secret: registry_token
    commands:
      # Navigate to mobile directory
      - cd mobile

      # Display environment info for debugging
      - echo "Build Number $DRONE_BUILD_NUMBER"
      - echo "Commit SHA ${DRONE_COMMIT_SHA:0:8}"
      - java -version
      - echo "ANDROID_HOME=$ANDROID_HOME"

      # Ensure curl is available for APK upload
      - |
        if command -v apt-get >/dev/null 2>&1; then
          apt-get update && apt-get install -y curl
        elif command -v apk >/dev/null 2>&1; then
          apk add --no-cache curl
        else
          echo "ERROR: No supported package manager found to install curl."
          exit 1
        fi

      # Accept Android SDK licenses
      - yes | sdkmanager --licenses || true

      # Install required SDK components for API 35
      - sdkmanager "platforms;android-35" "build-tools;35.0.0" || true

      # Run gradle via sh to avoid permission issues
      - sh ./gradlew :androidApp:assembleDebug --no-daemon --stacktrace

      # Verify APK was created
      - ls -la androidApp/build/outputs/apk/debug/

      # Find and upload APK
      - |
        apk_path=$(find androidApp/build/outputs/apk/debug -name "*.apk" -type f | head -1)
        if [ -z "$apk_path" ]; then
          echo "ERROR: No APK file found!"
          exit 1
        fi
        echo "Found APK: $apk_path"

        # Prepare upload variables
        build_number="${DRONE_BUILD_NUMBER}"
        commit_sha="${DRONE_COMMIT_SHA:0:8}"
        package_name="vibe80-android"
        apk_name="vibe80-debug-${commit_sha}.apk"

        echo "Uploading APK to package registry..."
        echo "Package: $package_name"
        echo "Version: $build_number"
        echo "Filename: $apk_name"

        # Upload to Gitea package registry
        curl --fail --user "$REGISTRY_USERNAME:$REGISTRY_TOKEN" \
          --upload-file "$apk_path" \
          "https://git.lab.adho.app/api/packages/mont5piques/generic/$package_name/$build_number/$apk_name"

        if [ $? -eq 0 ]; then
          echo "APK uploaded successfully!"
          echo "Download URL: https://git.lab.adho.app/api/packages/mont5piques/generic/$package_name/$build_number/$apk_name"
        else
          echo "ERROR: APK upload failed!"
          exit 1
        fi

  - name: build_image
    image: plugins/docker:20.14
    settings:
      username:
        from_secret: registry_username
      password:
        from_secret: registry_token
      registry: git.lab.adho.app
      repo: git.lab.adho.app/mont5piques/vibe80
      dockerfile: Dockerfile
      context: .
      mtu: 1440
      cache_from:
        - git.lab.adho.app/mont5piques/vibe80:latest
      tags:
        - ${DRONE_COMMIT_SHA:0:8}
        - latest

  - name: update_gitops_vibecoder
    image: alpine:3.20
    when:
      branch:
        - vibecoder
    environment:
      GITOPS_SSH_KEY:
        from_secret: gitops_ssh_key
    commands:
      - apk add --no-cache git openssh yq
      - mkdir -p ~/.ssh
      - echo "$GITOPS_SSH_KEY" > ~/.ssh/id_rsa
      - chmod 600 ~/.ssh/id_rsa
      - ssh-keyscan -H gitea.devops >> ~/.ssh/known_hosts 2>/dev/null || true

      - git clone git@gitea.devops:mont5piques/gitops.git gitops
      - cd gitops

      - export TAG="${DRONE_COMMIT_SHA:0:8}"

      - yq -i '
          (select(.kind=="Deployment" and .metadata.name=="vibecoder")
            .spec.template.spec.containers[] | select(.name=="vibecoder").image)
          = "git.lab.adho.app/mont5piques/vibe80:" + strenv(TAG)
        ' contabo/vibecoder/vibecoder.yml

      - git config user.email "drone@company.local"
      - git config user.name "drone-ci"
      - git add contabo/vibecoder/vibecoder.yml
      - 'git commit -m "vibecoder: bump image to ${DRONE_COMMIT_SHA:0:8}" || exit 0'
      - git push

  - name: vibe80_integration_loop
    image: alpine:3.20
    environment:
      BASE_URL: https://vibe80.lab.adho.app/
      WORKSPACE_ID:
        from_secret: workspace_id
      WORKSPACE_SECRET:
        from_secret: workspace_secret
    commands:
      - apk add --no-cache bash git jq curl
      - . scripts/parse_commit_metadata.sh
      - echo "Parsed session $SESSION_ID ; parsed worktree $WORKTREE_ID"
      - bash scripts/worktree_message.sh --text "Hello world"


trigger:
  event:
    - push
    - pull_request
